# HomeworkCI Docker Compose
# Production deployment configuration

services:
  # Backend server (Deno)
  server:
    build:
      context: .
      dockerfile: docker/server.Dockerfile
    container_name: homeworkci
    restart: unless-stopped
    ports:
      - "${CLIENT_PORT:-80}:8008"
    environment:
      - PORT=${PORT:-8008}
      - HOST=${HOST:-0.0.0.0}
      - PIPELINES_DIR=/app/pipelines
      - MODULES_DIR=/app/modules
      - DATA_DIR=/app/data
      - CONFIG_DIR=/app/config
      - SANDBOX_DIR=/app/tmp
      - SANDBOX_HOST_PATH=${SANDBOX_HOST_PATH:-/tmp/homeworkci}
      - SANDBOX_MAX_AGE_HOURS=${SANDBOX_MAX_AGE_HOURS:-24}
      - ENABLE_SCHEDULER=${ENABLE_SCHEDULER:-true}
      # Docker Runner settings
      - DOCKER_ENABLED=${DOCKER_ENABLED:-false}
      - DOCKER_DEFAULT_IMAGE=${DOCKER_DEFAULT_IMAGE:-alpine:3.19}
      - DOCKER_MEMORY_LIMIT=${DOCKER_MEMORY_LIMIT:-512m}
      - DOCKER_CPU_LIMIT=${DOCKER_CPU_LIMIT:-1}
      - DOCKER_NETWORK_DEFAULT=${DOCKER_NETWORK_DEFAULT:-bridge}
      - DOCKER_TIMEOUT_MS=${DOCKER_TIMEOUT_MS:-600000}
      # Update settings
      - GITHUB_REPO=${GITHUB_REPO:-}
      - AUTO_UPDATE_ENABLED=${AUTO_UPDATE_ENABLED:-false}
      - REPO_PATH=${REPO_PATH:-}
    volumes:
      # Persistent data
      - homeworkci-data:/app/data
      - homeworkci-config:/app/config
      # Editable content (can be mounted from host for development)
      - homeworkci-pipelines:/app/pipelines
      - homeworkci-modules:/app/modules
      # Temporary sandbox - bind mount for Docker-in-Docker access
      # Docker containers spawned from server need host path access
      - ${SANDBOX_HOST_PATH:-/tmp/homeworkci}:/app/tmp
      # Repository mount for auto-updates (optional, uncomment if REPO_PATH is set)
      # - ${REPO_PATH}:/app/repo:ro
      # Docker socket for Docker-in-Docker (required for docker module)
      - /var/run/docker.sock:/var/run/docker.sock
    # Run as root for Docker socket access (required for docker module)
    # Security note: Docker-in-Docker inherently requires elevated privileges
    user: root
    networks:
      - homeworkci-network
    healthcheck:
      test:
        [
          "CMD",
          "deno",
          "eval",
          "const r = await fetch('http://localhost:8008/api/health').catch(() => null); Deno.exit(r?.ok ? 0 : 1);",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  homeworkci-network:
    driver: bridge

volumes:
  homeworkci-data:
    driver: local
  homeworkci-config:
    driver: local
  homeworkci-pipelines:
    driver: local
  homeworkci-modules:
    driver: local
